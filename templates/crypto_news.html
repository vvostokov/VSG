{% extends "base.html" %}
{% from "_macros.html" import timestamp_to_datetime, datetime_format %}

{% block title %}Новости и анализ криптовалют{% endblock %}

{% block content %}
    <!-- Page Heading -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Новости и анализ криптовалют</h1>
    </div>

    <!-- News Trends Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Анализ трендов по новостям (Топ-10 активов портфеля)</h5>
        </div>
        <div class="card-body">
            {% if news_trends and top_10_tickers %}
            <div class="row">
                {% for ticker in top_10_tickers %}
                    {% set trend = news_trends[ticker] %}
                    <div class="col-12 col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title d-flex justify-content-between">
                                    <strong>{{ ticker }}</strong>
                                    <small class="text-muted">Новостей: {{ trend.total }}</small>
                                </h6>
                                {# ИЗМЕНЕНО: Показываем прогресс-бар, только если есть позитивные или негативные новости #}
                                {% if trend.total > 0 and (trend.positive > 0 or trend.negative > 0) %}
                                    {% set pos_percent = (trend.positive / trend.total * 100) | round %}
                                    {% set neg_percent = (trend.negative / trend.total * 100) | round %}
                                    {% set neu_percent = 100 - pos_percent - neg_percent %}
                                    <div class="progress" style="height: 20px;" title="Позитив: {{ trend.positive }}, Негатив: {{ trend.negative }}, Нейтральные: {{ trend.neutral }}">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ pos_percent }}%" aria-valuenow="{{ pos_percent }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ trend.positive if pos_percent > 10 else '' }}
                                        </div>
                                        <div class="progress-bar bg-danger" role="progressbar" style="width: {{ neg_percent }}%" aria-valuenow="{{ neg_percent }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ trend.negative if neg_percent > 10 else '' }}
                                        </div>
                                        <div class="progress-bar bg-secondary" role="progressbar" style="width: {{ neu_percent }}%" aria-valuenow="{{ neu_percent }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ trend.neutral if neu_percent > 10 else '' }}
                                        </div>
                                    </div>
                                {% else %}
                                    {# ИЗМЕНЕНО: Показываем разный текст, если новостей нет или если нет данных о тональности #}
                                    <p class="text-muted small mb-0">{{ "Свежих новостей для анализа не найдено." if trend.total == 0 else "Данные о тональности новостей недоступны." }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-center text-muted">Не удалось загрузить тренды. Возможно, в вашем портфеле нет крипто-активов или новости временно недоступны.</p>
            {% endif %}
        </div>
    </div>

    <!-- General News Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Последние мировые новости</h5>
        </div>
        <div class="list-group list-group-flush">
            {% if latest_news %}
                {% for article in latest_news %}
                    <a href="{{ article.url }}" target="_blank" rel="noopener noreferrer" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">
                                {{ article.title_ru }}
                                {# ИЗМЕНЕНО: Добавляем оценку от LLM в title для подробной информации #}
                                {% if article.sentiment and article.sentiment.compound is defined and article.sentiment.llm_score is defined %}
                                    {% set compound = article.sentiment.compound %}
                                    {% set llm_score = article.sentiment.llm_score %}
                                    {% if compound >= 0.05 %}
                                        <span class="badge badge-success ml-2" title="Оценка: {{ llm_score }}">Позитив</span>
                                    {% elif compound <= -0.05 %}
                                        <span class="badge badge-danger ml-2" title="Оценка: {{ llm_score }}">Негатив</span>
                                    {% else %}<span class="badge badge-secondary ml-2" title="Оценка: {{ llm_score }}">Нейтрал</span>{% endif %}
                                {% endif %}
                            </h6>
                            <small class="text-muted">{{ article.published_on | timestamp_to_datetime | datetime_format('%d.%m %H:%M') }}</small>
                        </div>
                        <p class="mb-1 small text-muted">{{ article.body_ru | truncate(150) }}</p>
                        <small class="text-muted">{{ article.source_info.name }}</small>
                    </a>
                {% endfor %}
            {% else %}
                <div class="list-group-item"><p class="text-center text-muted mb-0">Новости не найдены.</p></div>
            {% endif %}
        </div>
    </div>
{% endblock %}